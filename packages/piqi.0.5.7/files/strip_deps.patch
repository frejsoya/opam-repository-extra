commit 3c8f7005bb99e84584c8b50eddd564e828a299ce
Author: Anton Lavrik <alavrik@piqi.org>
Date:   Mon Oct 29 02:40:52 2012 -0500

    Add ./configure script and autodetect dependencies
    
    Don't build ulex, xmlm and easy-format third-party dependencies if they are
    already installed in the system.
    
    Even if they are not installed and we need to build them from deps/ don't
    include them in the piqi OCaml package. Instead, install them as separate
    packages as a part of "make ocaml-install" step.
    
    These changes will allows us to create Piqi distribution packages more easily.

diff --git a/.gitignore b/.gitignore
index 886a8bc..55d5c17 100644
--- a/.gitignore
+++ b/.gitignore
@@ -21,3 +21,5 @@ examples/erlang/piqi-erlang
 piqi-rpc/src/piqi-erlang
 tests/erlang_piqi/piqi-erlang
 
+# generated by ./configure
+/Makefile.config
diff --git a/INSTALL b/INSTALL
index 39895db..33ab1c9 100644
--- a/INSTALL
+++ b/INSTALL
@@ -75,27 +75,19 @@ INSTALLATION INSTRUCTIONS
 NOTE: these instruction are applicable only to Unix/Linux systems.
 
 
-1. Edit setenv.sh file to set build configuration variables if necessary.
+1. Run ./configure
 
-2. Apply build configuration by running
-        
-        . setenv.sh
-
-        or
+        Run "./configure --help" for the list of available options.
 
-        source setenv.sh
-
-3. Make sure that "ocamlfind" program is in PATH
-
-4. Build third-party components
+2. Build third-party dependencies
         
         make deps
 
-5. Build Piqi
+3. Build Piqi
 
         make
 
-6. Install "piqi" and "piqic" binaries (optional)
+4. Install "piqi" and "piqic" binaries (optional)
 
         make install
 
@@ -103,5 +95,14 @@ NOTE: these instruction are applicable only to Unix/Linux systems.
 RUNNING TESTS
 =============
 
-See tests/README for instructions.
+1. Prepare the environment
+
+        . setenv.sh
+
+2. Run the tests
+
+        cd tests; make
+
+
+See tests/README for further information.
 
diff --git a/INSTALL.ocaml b/INSTALL.ocaml
index 2b45705..e307abe 100644
--- a/INSTALL.ocaml
+++ b/INSTALL.ocaml
@@ -7,9 +7,12 @@ INSTALLATION INSTRUCTIONS
 
 1. Follow general build and installation instructions from the INSTALL file.
 
-        If you want Piqi libraries to be installed to a custom filesystem
-        location, configure the "PIQI_OCAML_PREFIX" variable in the setenv.sh
-        file.
+        If you want Piqi OCaml libraries to be installed to a custom filesystem
+        location, run ./configure with --ocaml-libdir=<DIR>
+
+        This will override ocamlfind setting determined by OCAMLFIND_DESTDIR
+        environment variable or by ocamlfind config. You can run
+        "ocamlfind printconf destdir" to see the current setting.
 
 
 2. Build Piqi runtime libraries for OCaml:
@@ -22,7 +25,7 @@ INSTALLATION INSTRUCTIONS
         make ocaml-install
 
 
-To uninstall previously installed Piqi libraries:
+To uninstall previously installed libraries:
 
         make ocaml-uninstall
 
diff --git a/Makefile b/Makefile
index a805a1b..6978c29 100644
--- a/Makefile
+++ b/Makefile
@@ -1,3 +1,4 @@
+include Makefile.config
 include $(PIQI_ROOT)/make/Makefile.dirs
 
 
@@ -7,7 +8,9 @@ DIRS = \
 	piqicc piqic piqilib piqi-tools \
 
 
-.PHONY: deps install ocaml ocaml-install ocaml-uninstall erlang erlang-clean distclean
+.PHONY: deps build-dir install distclean \
+	ocaml ocaml-install ocaml-uninstall \
+	erlang erlang-clean
 
 
 # export installation and search path for OCaml dependencies
@@ -18,20 +21,28 @@ export OCAMLFIND_DESTDIR OCAMLPATH
 endif
 
 
-# export installation path for Piqi OCaml libraries
+# export installation path for third-party deps and Piqi OCaml libraries
 ifneq ($(findstring ocaml-,$(MAKECMDGOALS)),)
-ifneq ($(PIQI_OCAML_PREFIX),)
-OCAMLFIND_INSTFLAGS = -destdir $(PIQI_OCAML_PREFIX)
+ifneq ($(PIQI_OCAML_DESTDIR),)
+OCAMLFIND_DESTDIR = $(PIQI_OCAML_DESTDIR)
+OCAMLPATH = $(OCAMLFIND_DESTDIR)
+export OCAMLFIND_DESTDIR OCAMLPATH
 endif
 endif
 
 
-deps:
+pre_target:: build-dir
+
+
+deps: build-dir
 	$(MAKE) -C deps
-	mkdir -p $(OCAMLFIND_DESTDIR)
 	$(MAKE) -C deps install
 
 
+build-dir:
+	mkdir -p $(PIQI_BUILD)/lib/ocaml
+
+
 install:
 	-install -d $(PIQI_PREFIX)/bin
 	install piqi-tools/piqi $(PIQI_PREFIX)/bin
@@ -43,12 +54,14 @@ ocaml:
 
 
 ocaml-install: ocaml-uninstall
-	test -d $(PIQI_OCAML_PREFIX) || mkdir -p $(PIQI_OCAML_PREFIX)
-	ocamlfind install $(OCAMLFIND_INSTFLAGS) piqi `ls $(PIQI_BUILD)/lib/ocaml/piqi/*`
+	test -d $(PIQI_OCAML_DESTDIR) || mkdir -p $(PIQI_OCAML_DESTDIR)
+	ocamlfind install piqi `ls $(PIQI_BUILD)/lib/ocaml/piqi/*`
+	$(MAKE) -C deps install
 
 
 ocaml-uninstall:
-	ocamlfind remove $(OCAMLFIND_INSTFLAGS) piqi
+	ocamlfind remove piqi
+	$(MAKE) -C deps uninstall
 
 
 erlang:
@@ -66,6 +79,9 @@ clean:: erlang-clean
 
 
 distclean:
-	$(MAKE) clean
-	rm -rf $(PIQI_BUILD)
+	if [ -f Makefile.config ]; then \
+		$(MAKE) clean; \
+		rm -rf $(PIQI_BUILD); \
+		rm Makefile.config; \
+	fi
 
diff --git a/configure b/configure
new file mode 100755
index 0000000..6eb2d6b
--- /dev/null
+++ b/configure
@@ -0,0 +1,101 @@
+#!/bin/sh
+
+# "prefix" path for installing "piqi" and "piqic" executables
+PREFIX=/usr/local
+
+# path for installing Piqi OCaml libraries. If not set, the ocamlfind
+# destination directory path will be used. Such path is determined by
+# OCAMLFIND_DESTDIR environment variable or by ocamlfind config. You can run
+# "ocamlfind printconf destdir" to see the current setting.
+OCAML_LIBDIR=
+
+
+usage() {
+echo "
+Configuration:
+  -h, --help              display this help and exit
+
+Installation directories:
+  --prefix PREFIX         install piqi executables in PREFIX/bin/
+                          [/usr/local]
+  --ocaml-libdir DIR      install OCaml libraries to DIR
+                          [\`ocamlfind printconf destdir\`]
+"
+}
+
+
+while [ "$#" != "0" ]
+do
+    opt="$1"
+    case "$opt" in
+        --*=*)
+            opt_value=`expr "X$opt" : '[^=]*=\(.*\)'`
+            ;;
+        --*)
+            shift
+            opt_value="$1"
+            ;;
+    esac
+
+    case "$opt" in
+        --prefix | --prefix=*)
+            PREFIX="$opt_value"
+            ;;
+        --ocaml-libdir | --ocaml-libdir=*)
+            OCAML_LIBDIR="$opt_value"
+            ;;
+        -h|-help|--help)
+            usage
+            exit 0
+            ;;
+        *)
+            echo "configure: run 'configure -h' to get help" 1>&2
+            exit 1
+            ;;
+    esac
+
+    shift
+done
+
+
+OCAMLFIND="`which ocamlfind`"
+if [ $? -ne 0 ]
+then
+    echo "configure: error: ocamlfind is required. See INSTALL for details" 1>&2
+    exit 1
+fi
+
+
+M=Makefile.config
+
+# configure options
+echo "# Makefile.config generated by ./configure" > $M
+echo >> $M
+echo "PIQI_PREFIX=$PREFIX" >> $M
+echo "PIQI_OCAML_DESTDIR=$OCAML_LIBDIR" >> $M
+echo >> $M
+
+# build environment
+echo "export PIQI_ROOT = `pwd`" >> $M
+# temporary build directory
+echo "export PIQI_BUILD = \$(PIQI_ROOT)/build" >> $M
+# path to .piqi files
+echo "export PIQI_DIR = \$(PIQI_ROOT)" >> $M
+echo >> $M
+
+# figure out which dependencies we need to build
+echo "checking whether necessary dependencies are already installed..."
+for i in xmlm ulex easy-format
+do
+    dir="`ocamlfind query $i 2>/dev/null`"
+    if [ $? -eq 0 ]
+    then
+        echo "$i is installed in $dir"
+        echo "SKIP-$i = 1" >> $M
+    else
+        echo "$i is not installed; it will be built during \"make deps\""
+    fi
+done
+
+
+# ex: sw=4 ts=4 et
diff --git a/deps/Makefile b/deps/Makefile
index 89876e1..45d1ad4 100644
--- a/deps/Makefile
+++ b/deps/Makefile
@@ -1,6 +1,24 @@
+include ../Makefile.config
 include $(PIQI_ROOT)/make/Makefile.dirs
 
-DIRS = ulex-1.1 easy-format-1.0.0 xmlm-1.0.2
+
+ifndef SKIP-ulex
+ULEX_DIR = ulex-1.1
+endif
+
+ifndef SKIP-xmlm
+XMLM_DIR = xmlm-1.0.2
+endif
+
+ifndef SKIP-easy-format
+EASY_FORMAT_DIR = easy-format-1.0.0
+endif
+
+
+DIRS = $(ULEX_DIR) $(XMLM_DIR) $(EASY_FORMAT_DIR)
 
 
 install: dirs
+
+uninstall: dirs
+
diff --git a/deps/xmlm-1.0.2/Makefile b/deps/xmlm-1.0.2/Makefile
index 3ac2e45..e85bcbb 100644
--- a/deps/xmlm-1.0.2/Makefile
+++ b/deps/xmlm-1.0.2/Makefile
@@ -1,4 +1,4 @@
-include $(PIQI_ROOT)/make/Makefile.ocaml
+OCAMLMAKEFILE := ../../make/OCamlMakefile
 
 
 RESULT = xmlm
diff --git a/make/Makefile.dirs b/make/Makefile.dirs
index aed3976..712e1e3 100644
--- a/make/Makefile.dirs
+++ b/make/Makefile.dirs
@@ -1,6 +1,6 @@
 .PHONY: all dirs clean pre_target post_target
 
-all: dirs pre_target post_target
+all: pre_target dirs post_target
 
 
 dirs: $(DIRS)
diff --git a/make/piqi-fix-libinstall b/make/piqi-fix-libinstall
index ce05918..233f3b8 100755
--- a/make/piqi-fix-libinstall
+++ b/make/piqi-fix-libinstall
@@ -24,7 +24,7 @@ ln -s "$BASE/$1" "$BASE/$2"
 DEST="$BASE/piqi"
 
 # pieces to put there
-PARTS="ulex easy-format xmlm syntax runtime lib"
+PARTS="syntax runtime lib"
 
 
 # remove an old piqi lib installation directory
diff --git a/piqi-camlp4/Makefile b/piqi-camlp4/Makefile
index 3503bad..0808310 100644
--- a/piqi-camlp4/Makefile
+++ b/piqi-camlp4/Makefile
@@ -1,3 +1,4 @@
+include ../Makefile.config
 include $(PIQI_ROOT)/make/Makefile.ocaml
 
 
diff --git a/piqi-erlang/Makefile b/piqi-erlang/Makefile
index 4fbf2c0..0744894 100644
--- a/piqi-erlang/Makefile
+++ b/piqi-erlang/Makefile
@@ -1,3 +1,4 @@
+include ../Makefile.config
 include $(PIQI_ROOT)/make/Makefile.dirs
 
 DIRS = src piqic-erlang-ext
diff --git a/piqi-erlang/piqic-erlang-ext/Makefile b/piqi-erlang/piqic-erlang-ext/Makefile
index 076a114..08bb268 100644
--- a/piqi-erlang/piqic-erlang-ext/Makefile
+++ b/piqi-erlang/piqic-erlang-ext/Makefile
@@ -1,3 +1,4 @@
+include ../../Makefile.config
 
 PIQIC_PLUGIN = piqic-erlang-ext
 
diff --git a/piqi-erlang/src/Makefile b/piqi-erlang/src/Makefile
index 73b0423..b5e7aba 100644
--- a/piqi-erlang/src/Makefile
+++ b/piqi-erlang/src/Makefile
@@ -1,3 +1,4 @@
+include ../../Makefile.config
 
 ERL_SOURCES = \
 	$(PIQI_ERL_FILES) \
diff --git a/piqi-rpc/Makefile b/piqi-rpc/Makefile
index 7f984d8..83acb47 100644
--- a/piqi-rpc/Makefile
+++ b/piqi-rpc/Makefile
@@ -1,3 +1,4 @@
+include ../Makefile.config
 include $(PIQI_ROOT)/make/Makefile.dirs
 
 DIRS = src piqic-erlang-rpc
diff --git a/piqi-rpc/piqic-erlang-rpc/Makefile b/piqi-rpc/piqic-erlang-rpc/Makefile
index 1fead14..5957c5e 100644
--- a/piqi-rpc/piqic-erlang-rpc/Makefile
+++ b/piqi-rpc/piqic-erlang-rpc/Makefile
@@ -1,3 +1,4 @@
+include ../../Makefile.config
 
 PIQIC_PLUGIN = piqic-erlang-rpc
 
diff --git a/piqi-rpc/src/Makefile b/piqi-rpc/src/Makefile
index 641931f..e2cb3a7 100644
--- a/piqi-rpc/src/Makefile
+++ b/piqi-rpc/src/Makefile
@@ -1,3 +1,4 @@
+include ../../Makefile.config
 
 ERL_SOURCES = \
 	piqi_rpc_runtime.erl \
diff --git a/piqi-tools/Makefile b/piqi-tools/Makefile
index 412cbec..e969a4e 100644
--- a/piqi-tools/Makefile
+++ b/piqi-tools/Makefile
@@ -1,3 +1,4 @@
+include ../Makefile.config
 include $(PIQI_ROOT)/make/Makefile.ocaml
 
 
diff --git a/piqi-tools/piqi_http.ml b/piqi-tools/piqi_http.ml
index f43cb25..ccf4cd6 100644
--- a/piqi-tools/piqi_http.ml
+++ b/piqi-tools/piqi_http.ml
@@ -1,4 +1,4 @@
-(*pp camlp4o -I `ocamlfind query piqi.ulex` pa_ulex.cma *)
+(*pp camlp4o -I `ocamlfind query ulex` pa_ulex.cma *)
 (*
    Copyright 2009, 2010, 2011, 2012 Anton Lavrik
 
diff --git a/piqi-tools/piqi_of_proto.ml b/piqi-tools/piqi_of_proto.ml
index e18c3e3..07ff125 100644
--- a/piqi-tools/piqi_of_proto.ml
+++ b/piqi-tools/piqi_of_proto.ml
@@ -1,4 +1,4 @@
-(*pp camlp4o -I `ocamlfind query piqi.ulex` -I `ocamlfind query piqi.syntax` pa_labelscope.cmo pa_openin.cmo pa_ulex.cma *)
+(*pp camlp4o -I `ocamlfind query ulex` -I `ocamlfind query piqi.syntax` pa_labelscope.cmo pa_openin.cmo pa_ulex.cma *)
 (*
    Copyright 2009, 2010, 2011, 2012 Anton Lavrik
 
diff --git a/piqic/Makefile b/piqic/Makefile
index 14171bd..05e782a 100644
--- a/piqic/Makefile
+++ b/piqic/Makefile
@@ -1,3 +1,4 @@
+include ../Makefile.config
 include $(PIQI_ROOT)/make/Makefile.ocaml
 include $(PIQI_ROOT)/piqilib/Makefile.piqi_common
 
diff --git a/piqicc/Makefile b/piqicc/Makefile
index a1c99e4..13a866a 100644
--- a/piqicc/Makefile
+++ b/piqicc/Makefile
@@ -1,3 +1,4 @@
+include ../Makefile.config
 include $(PIQI_ROOT)/make/Makefile.ocaml
 include $(PIQI_ROOT)/piqilib/Makefile.piqi_common
 
diff --git a/piqilib/META b/piqilib/META
index e351134..eec6eba 100644
--- a/piqilib/META
+++ b/piqilib/META
@@ -1,4 +1,4 @@
 description = "The Piqi library"
-requires = "piqi.ulex piqi.easy-format piqi.xmlm piqi.runtime"
+requires = "ulex easy-format xmlm piqi.runtime"
 archive(byte) = "piqilib.cma"
 archive(native) = "piqilib.cmxa"
diff --git a/piqilib/Makefile b/piqilib/Makefile
index 3f91bf7..c0ab32e 100644
--- a/piqilib/Makefile
+++ b/piqilib/Makefile
@@ -1,3 +1,4 @@
+include ../Makefile.config
 include $(PIQI_ROOT)/make/Makefile.ocaml
 include $(PIQI_ROOT)/piqilib/Makefile.piqi_common
 
diff --git a/piqilib/piq_lexer.ml b/piqilib/piq_lexer.ml
index 7cc6222..ff1492b 100644
--- a/piqilib/piq_lexer.ml
+++ b/piqilib/piq_lexer.ml
@@ -1,4 +1,4 @@
-(*pp camlp4o -I `ocamlfind query piqi.ulex` pa_ulex.cma *)
+(*pp camlp4o -I `ocamlfind query ulex` pa_ulex.cma *)
 (*
    Copyright 2009, 2010, 2011, 2012 Anton Lavrik
 
diff --git a/piqirun-ocaml/Makefile b/piqirun-ocaml/Makefile
index 73bef9a..b3f7130 100644
--- a/piqirun-ocaml/Makefile
+++ b/piqirun-ocaml/Makefile
@@ -1,3 +1,4 @@
+include ../Makefile.config
 include $(PIQI_ROOT)/make/Makefile.ocaml
 
 
diff --git a/setenv.sh b/setenv.sh
index 95b13d5..33addc4 100644
--- a/setenv.sh
+++ b/setenv.sh
@@ -1,25 +1,27 @@
+# run this script if you want to run tests; otherwise, use ./configure
 
-# "prefix" path for installing "piqi" and "piqic" executables
-export PIQI_PREFIX=/usr/local
-
-
-# "prefix" path for installing Piqi OCaml libraries; if not set, the OCaml
-# installation's library path (i.e. `ocamlc -where`) will be used
-export PIQI_OCAML_PREFIX=
-
-
-#
-# don't change the settings below -- they are necessary for the build process
-#
 
 export PIQI_ROOT="`pwd`"
 
-# directory for temporary files required for the build
+# temporary build directory
 export PIQI_BUILD="$PIQI_ROOT/build"
 
-# path to piqi and piqic (required for tests)
+# path to piqi and piqic executables
 export PATH="$PIQI_ROOT/bin:$PATH"
 
-# path to .piqi files (required for tests)
+# path to .piqi files
 export PIQI_DIR="$PIQI_ROOT"
 
+
+# this is for backward compatibility with older packaging scripts that were
+# created before we added ./configure script
+if [ ! -f Makefile.config ]
+then
+        ./configure
+        if [ $? -ne 0 ]
+        then
+                echo "./configure command failed" 1>&2
+                exit 1
+        fi
+fi
+
diff --git a/tests/Makefile b/tests/Makefile
index a15a75e..35654f7 100644
--- a/tests/Makefile
+++ b/tests/Makefile
@@ -1,3 +1,4 @@
+include ../Makefile.config
 include $(PIQI_ROOT)/make/Makefile.dirs
 
 
